require('../../common/vendor.js');(global["webpackJsonp"]=global["webpackJsonp"]||[]).push([["otherpages/chat/room/room"],{"01b2":function(t,e,o){"use strict";(function(t){o("d947");i(o("66fd"));var e=i(o("0beb"));function i(t){return t&&t.__esModule?t:{default:t}}wx.__webpack_require_UNI_MP_PLUGIN__=o,t(e.default)}).call(this,o("543d")["createPage"])},"0beb":function(t,e,o){"use strict";o.r(e);var i=o("f95c"),n=o("32b7");for(var r in n)["default"].indexOf(r)<0&&function(t){o.d(e,t,(function(){return n[t]}))}(r);o("547e");var s=o("f0c5"),a=Object(s["a"])(n["default"],i["b"],i["c"],!1,null,null,null,!1,i["a"],void 0);e["default"]=a.exports},"32b7":function(t,e,o){"use strict";o.r(e);var i=o("f0a4"),n=o.n(i);for(var r in i)["default"].indexOf(r)<0&&function(t){o.d(e,t,(function(){return i[t]}))}(r);e["default"]=n.a},"4d1b":function(t,e,o){},"547e":function(t,e,o){"use strict";var i=o("4d1b"),n=o.n(i);n.a},f0a4:function(t,e,o){"use strict";(function(t){Object.defineProperty(e,"__esModule",{value:!0}),e.default=void 0;var i=s(o("dc47")),n=s(o("3a0e")),r=s(o("a88e"));function s(t){return t&&t.__esModule?t:{default:t}}function a(){/*! regenerator-runtime -- Copyright (c) 2014-present, Facebook, Inc. -- license (MIT): https://github.com/facebook/regenerator/blob/main/LICENSE */a=function(){return t};var t={},e=Object.prototype,o=e.hasOwnProperty,i="function"==typeof Symbol?Symbol:{},n=i.iterator||"@@iterator",r=i.asyncIterator||"@@asyncIterator",s=i.toStringTag||"@@toStringTag";function c(t,e,o){return Object.defineProperty(t,e,{value:o,enumerable:!0,configurable:!0,writable:!0}),t[e]}try{c({},"")}catch(k){c=function(t,e,o){return t[e]=o}}function u(t,e,o,i){var n=e&&e.prototype instanceof d?e:d,r=Object.create(n.prototype),s=new b(i||[]);return r._invoke=function(t,e,o){var i="suspendedStart";return function(n,r){if("executing"===i)throw new Error("Generator is already running");if("completed"===i){if("throw"===n)throw r;return I()}for(o.method=n,o.arg=r;;){var s=o.delegate;if(s){var a=w(s,o);if(a){if(a===l)continue;return a}}if("next"===o.method)o.sent=o._sent=o.arg;else if("throw"===o.method){if("suspendedStart"===i)throw i="completed",o.arg;o.dispatchException(o.arg)}else"return"===o.method&&o.abrupt("return",o.arg);i="executing";var c=h(t,e,o);if("normal"===c.type){if(i=o.done?"completed":"suspendedYield",c.arg===l)continue;return{value:c.arg,done:o.done}}"throw"===c.type&&(i="completed",o.method="throw",o.arg=c.arg)}}}(t,o,s),r}function h(t,e,o){try{return{type:"normal",arg:t.call(e,o)}}catch(k){return{type:"throw",arg:k}}}t.wrap=u;var l={};function d(){}function f(){}function p(){}var g={};c(g,n,(function(){return this}));var m=Object.getPrototypeOf,v=m&&m(m(T([])));v&&v!==e&&o.call(v,n)&&(g=v);var y=p.prototype=d.prototype=Object.create(g);function _(t){["next","throw","return"].forEach((function(e){c(t,e,(function(t){return this._invoke(e,t)}))}))}function x(t,e){var i;this._invoke=function(n,r){function s(){return new e((function(i,s){(function i(n,r,s,a){var c=h(t[n],t,r);if("throw"!==c.type){var u=c.arg,l=u.value;return l&&"object"==typeof l&&o.call(l,"__await")?e.resolve(l.__await).then((function(t){i("next",t,s,a)}),(function(t){i("throw",t,s,a)})):e.resolve(l).then((function(t){u.value=t,s(u)}),(function(t){return i("throw",t,s,a)}))}a(c.arg)})(n,r,i,s)}))}return i=i?i.then(s,s):s()}}function w(t,e){var o=t.iterator[e.method];if(void 0===o){if(e.delegate=null,"throw"===e.method){if(t.iterator.return&&(e.method="return",e.arg=void 0,w(t,e),"throw"===e.method))return l;e.method="throw",e.arg=new TypeError("The iterator does not provide a 'throw' method")}return l}var i=h(o,t.iterator,e.arg);if("throw"===i.type)return e.method="throw",e.arg=i.arg,e.delegate=null,l;var n=i.arg;return n?n.done?(e[t.resultName]=n.value,e.next=t.nextLoc,"return"!==e.method&&(e.method="next",e.arg=void 0),e.delegate=null,l):n:(e.method="throw",e.arg=new TypeError("iterator result is not an object"),e.delegate=null,l)}function L(t){var e={tryLoc:t[0]};1 in t&&(e.catchLoc=t[1]),2 in t&&(e.finallyLoc=t[2],e.afterLoc=t[3]),this.tryEntries.push(e)}function S(t){var e=t.completion||{};e.type="normal",delete e.arg,t.completion=e}function b(t){this.tryEntries=[{tryLoc:"root"}],t.forEach(L,this),this.reset(!0)}function T(t){if(t){var e=t[n];if(e)return e.call(t);if("function"==typeof t.next)return t;if(!isNaN(t.length)){var i=-1,r=function e(){for(;++i<t.length;)if(o.call(t,i))return e.value=t[i],e.done=!1,e;return e.value=void 0,e.done=!0,e};return r.next=r}}return{next:I}}function I(){return{value:void 0,done:!0}}return f.prototype=p,c(y,"constructor",p),c(p,"constructor",f),f.displayName=c(p,s,"GeneratorFunction"),t.isGeneratorFunction=function(t){var e="function"==typeof t&&t.constructor;return!!e&&(e===f||"GeneratorFunction"===(e.displayName||e.name))},t.mark=function(t){return Object.setPrototypeOf?Object.setPrototypeOf(t,p):(t.__proto__=p,c(t,s,"GeneratorFunction")),t.prototype=Object.create(y),t},t.awrap=function(t){return{__await:t}},_(x.prototype),c(x.prototype,r,(function(){return this})),t.AsyncIterator=x,t.async=function(e,o,i,n,r){void 0===r&&(r=Promise);var s=new x(u(e,o,i,n),r);return t.isGeneratorFunction(o)?s:s.next().then((function(t){return t.done?t.value:s.next()}))},_(y),c(y,s,"Generator"),c(y,n,(function(){return this})),c(y,"toString",(function(){return"[object Generator]"})),t.keys=function(t){var e=[];for(var o in t)e.push(o);return e.reverse(),function o(){for(;e.length;){var i=e.pop();if(i in t)return o.value=i,o.done=!1,o}return o.done=!0,o}},t.values=T,b.prototype={constructor:b,reset:function(t){if(this.prev=0,this.next=0,this.sent=this._sent=void 0,this.done=!1,this.delegate=null,this.method="next",this.arg=void 0,this.tryEntries.forEach(S),!t)for(var e in this)"t"===e.charAt(0)&&o.call(this,e)&&!isNaN(+e.slice(1))&&(this[e]=void 0)},stop:function(){this.done=!0;var t=this.tryEntries[0].completion;if("throw"===t.type)throw t.arg;return this.rval},dispatchException:function(t){if(this.done)throw t;var e=this;function i(o,i){return s.type="throw",s.arg=t,e.next=o,i&&(e.method="next",e.arg=void 0),!!i}for(var n=this.tryEntries.length-1;n>=0;--n){var r=this.tryEntries[n],s=r.completion;if("root"===r.tryLoc)return i("end");if(r.tryLoc<=this.prev){var a=o.call(r,"catchLoc"),c=o.call(r,"finallyLoc");if(a&&c){if(this.prev<r.catchLoc)return i(r.catchLoc,!0);if(this.prev<r.finallyLoc)return i(r.finallyLoc)}else if(a){if(this.prev<r.catchLoc)return i(r.catchLoc,!0)}else{if(!c)throw new Error("try statement without catch or finally");if(this.prev<r.finallyLoc)return i(r.finallyLoc)}}}},abrupt:function(t,e){for(var i=this.tryEntries.length-1;i>=0;--i){var n=this.tryEntries[i];if(n.tryLoc<=this.prev&&o.call(n,"finallyLoc")&&this.prev<n.finallyLoc){var r=n;break}}r&&("break"===t||"continue"===t)&&r.tryLoc<=e&&e<=r.finallyLoc&&(r=null);var s=r?r.completion:{};return s.type=t,s.arg=e,r?(this.method="next",this.next=r.finallyLoc,l):this.complete(s)},complete:function(t,e){if("throw"===t.type)throw t.arg;return"break"===t.type||"continue"===t.type?this.next=t.arg:"return"===t.type?(this.rval=this.arg=t.arg,this.method="return",this.next="end"):"normal"===t.type&&e&&(this.next=e),l},finish:function(t){for(var e=this.tryEntries.length-1;e>=0;--e){var o=this.tryEntries[e];if(o.finallyLoc===t)return this.complete(o.completion,o.afterLoc),S(o),l}},catch:function(t){for(var e=this.tryEntries.length-1;e>=0;--e){var o=this.tryEntries[e];if(o.tryLoc===t){var i=o.completion;if("throw"===i.type){var n=i.arg;S(o)}return n}}throw new Error("illegal catch attempt")},delegateYield:function(t,e,o){return this.delegate={iterator:T(t),resultName:e,nextLoc:o},"next"===this.method&&(this.arg=void 0),l}},t}function c(t,e,o,i,n,r,s){try{var a=t[r](s),c=a.value}catch(u){return void o(u)}a.done?e(c):Promise.resolve(c).then(i,n)}var u={components:{chatMessage:function(){Promise.all([o.e("common/vendor"),o.e("otherpages/components/chat-message/chat-message")]).then(function(){return resolve(o("3510"))}.bind(null,o)).catch(o.oe)}},data:function(){return{emjoyList:n.default.emjoyList,emjoyShow:!1,chatMore:!1,formData:{content:"",goods_id:0,order_id:0,image:""},isNetWork:!1,send:!1,messageList:[],page:1,isAll:!1,isLoading:0,showLoading:!1,jumpBottom:null,scrollTop:0,scrollPosition:0,siteId:0,skuId:0,orderId:0,siteName:"",shopInfo:{},userInfo:{},style:{},inputFirst:0,inputShow:!1,inputOffsetBottom:0,goods_type:{promotion_name:"",promotion_id:""}}},mixins:[i.default,r.default],computed:{chatBottom:function(){return this.emjoyShow||this.chatMore||this.inputShow}},onLoad:function(e){if(!e.site_id)return this.$util.showToast({title:"缺少必要参数"}),void setTimeout((function(){t.navigateBack()}),1e3);this.siteId=e.site_id,this.getShopInfo(),this.skuId=e.sku_id?e.sku_id:0,this.orderId=e.order_id?e.order_id:0,(this.skuId||this.orderId)&&(this.send=!0),e.type?this.goods_type.promotion_name=e.type:this.goods_type.promotion_name="",e.type_id?this.goods_type.promotion_id=e.type_id:this.goods_type.promotion_id="",t.getStorageSync("token")?(this.getUserInfo(),this.inputFirst=0,this.inputShow=!1,this.inputOffsetBottom=0):this.$util.redirectTo("/pages/login/login/login")},onReady:function(){var e=this;t.onKeyboardHeightChange((function(t){e.inputOffsetBottom=t.height,0===t.height&&(e.focus=!1)}))},methods:{onEditorReady:function(){t.createSelectorQuery().select("#editor").context((function(t){})).exec()},onEditorinput:function(){var e=this;t.createSelectorQuery().select("#editor").context((function(t){e.editorCtx=t.context,e.editorCtx.getContents({success:function(t){e.formData.content=t.html}})})).exec()},openChatMore:function(){var t=this;this.$util.isAndroid&&(this.inputShow=!1,this.inputFirst=1),this.chatMore=!this.chatMore,this.emjoyShow=!1,this.$nextTick((function(){t.setPageScrollTo()}))},getShopInfo:function(){var e=this;0==this.siteId?(this.siteName="平台客服",t.setNavigationBarTitle({title:this.siteName})):this.$api.sendRequest({url:"/api/shop/info",data:{site_id:this.siteId},success:function(o){0==o.code&&(e.shopInfo=o.data,e.siteName=o.data.site_name,t.setNavigationBarTitle({title:e.siteName}))}})},getUserInfo:function(){var t=this;this.$api.sendRequest({url:"/api/member/info",success:function(e){0==e.code&&(t.userInfo=e.data)}})},getChatList:function(){var t=this;this.isAll?t.mescroll&&t.mescroll.endSuccess():this.isLoading||(this.isLoading=!0,console.log(this.page,"this.page"),1==this.page&&(this.messageList=[]),this.$api.sendRequest({url:"/servicer/api/chat/dialogs",data:{servicer_id:this.servicer_id,page:this.page,limit:7,site_id:t.siteId},success:function(e){if(t.page+=1,console.log(t.page,"this.page"),e.code>=0&&e.data){console.log(e.data.list.length,"res.data.list"),e.data.list&&e.data.list.length<5&&(t.isAll=!0);var o=0;this.messageList&&(o=this.messageList.slice(-1).id+1);var i=[];if(t.skuId){var n={id:o,isItMe:!0,contentType:"sendGood",sku_id:t.skuId};i.push(n),o+=1}var r=e.data.list;if(console.log(r,"arr"),r.length)for(var s=0;s<r.length;s++){var a={};0==r[s].content_type?(a.id=o,a.content=0==r[s].type?r[s].consumer_say:r[s].servicer_say,a.isItMe=0==r[s].type,a.contentType="string",a.sendStatus=!0,console.log(r[s],"arr[i]"),r[s].avatar?a.avatar=r[s].avatar:a.avatar=r[s].logo):1==r[s].content_type?(a.id=o,a.isItMe=0==r[s].type,1!=r[s].type?a.contentType="goods":a.contentType="goodssku",a.sku_id=r[s].goods_sku_id,a.send=!1,a.sendStatus=!0,r[s].avatar?a.avatar=r[s].avatar:a.avatar=r[s].logo):2==r[s].content_type?(a.id=o,a.isItMe=0==r[s].type,a.contentType="order",a.order_id=r[s].order_id,a.send=!1,a.sendStatus=!0,r[s].avatar?a.avatar=r[s].avatar:a.avatar=r[s].logo):3==r[s].content_type&&(a.id=o,a.isItMe=0==r[s].type,a.contentType="image",a.id=o,a.image=0==r[s].type?r[s].consumer_say:r[s].servicer_say,a.sendStatus=!0,r[s].avatar?a.avatar=r[s].avatar:a.avatar=r[s].logo),i.push(a),o+=1}if(2==t.page){var c={};c.id=o,t.servicer_id>0?c.contentType="online":0==t.servicer_id&&(c.contentType="noline"),i.push(c),o+=1}t.isLoading=!1,console.log(t.messageList,"that.messageList"),console.log(i,"newArr"),i.length&&(t.messageList=i.concat(t.messageList),t.$nextTick((function(){if(2==t.page)t.setPageScrollTo();else{var e="#chat"+i.length;t.setPageScrollTo(e)}})))}else this.$util.showToast({title:e.message})}}))},setPageScrollTo:function(e){if(e){var o=t.createSelectorQuery().in(this).select(e);o.boundingClientRect((function(e){t.pageScrollTo({scrollTop:e.top-30,duration:0})})).exec()}else{var i=t.createSelectorQuery().in(this);i.select(".room-content-box").boundingClientRect((function(e){t.pageScrollTo({scrollTop:e.height-30,duration:0})})).exec()}},sendGood:function(t,e){this.sendMsg("goods"),this.messageList.splice(e,1)},sendOrder:function(t,e){this.sendMsg("order"),this.messageList.splice(e,1)},sendMsg:function(e){if(!this.isNetWork){this.isNetWork=!0;var o=this;if("goods"==e){var i={};""!=this.goods_type.promotion_id&&(i.promotion_id=this.goods_type.promotion_id,i.promotion_name=this.goods_type.promotion_name),this.$api.sendRequest({url:"/servicer/api/chat/say",data:{goods_id:this.skuId,servicer_id:this.servicer_id,content_type:1,site_id:this.siteId,relate_data:JSON.stringify(i)},success:function(t){o.send=!1,o.joinData("send","goods")},complete:function(){o.isNetWork=!1}})}else if("order"==e)this.$api.sendRequest({url:"/servicer/api/chat/say",data:{order_id:this.orderId,servicer_id:this.servicer_id,site_id:this.siteId,content_type:2},success:function(t){o.send=!1,o.joinData("send","order")},complete:function(){o.isNetWork=!1}});else if("image"==e)o.joinData("send","image"),this.$api.sendRequest({url:"/servicer/api/chat/say",data:{message:this.formData.image.trim(),servicer_id:this.servicer_id,site_id:this.siteId,content_type:3},success:function(t){console.log(t,"图片上传成功")},error:function(){var e=this;o.messageList[o.messageList.length-1].sendStatus=!1,t.createSelectorQuery().select("#editor").context((function(t){e.editorCtx=t.context,e.editorCtx.clear()})).exec()},complete:function(){o.isNetWork=!1}});else{console.log(this.formData.content,"this.formData.content");var n=this.formData.content,r=n.replace(/<p>/,""),s=r.replace(/<\/p>/,""),a=s.replace(/<br>/,"");if("<p></p>"==n||"<p><br></p>"==n||!a.trim())return this.$util.showToast({title:"发送内容不能为空"}),t.createSelectorQuery().select("#editor").context((function(t){o.editorCtx=t.context,o.editorCtx.clear()})).exec(),void(o.isNetWork=!1);o.joinData("send","string"),this.$api.sendRequest({url:"/servicer/api/chat/say",data:{message:this.formData.content,servicer_id:this.servicer_id,site_id:this.siteId,content_type:0},success:function(e){var i=this;console.log(e,"文字上传成功"),o.formData.content="<p></p>",t.createSelectorQuery().select("#editor").context((function(t){i.editorCtx=t.context,i.editorCtx.clear()})).exec()},error:function(){var e=this;o.messageList[o.messageList.length-1].sendStatus=!1,t.createSelectorQuery().select("#editor").context((function(t){e.editorCtx=t.context,e.editorCtx.clear()})).exec()},complete:function(){o.isNetWork=!1}})}}},joinData:function(t,e){var o=this;return function(t){return function(){var e=this,o=arguments;return new Promise((function(i,n){var r=t.apply(e,o);function s(t){c(r,i,n,s,a,"next",t)}function a(t){c(r,i,n,s,a,"throw",t)}s(void 0)}))}}(a().mark((function i(){var n;return a().wrap((function(i){while(1)switch(i.prev=i.next){case 0:"send"==t&&(n={isItMe:!0,contentType:e,sendStatus:!0},"string"==e?n.content=o.formData.content:"order"==e?n.order_id=o.orderId:"goods"==e?n.sku_id=o.skuId:"image"==e&&(n.image=o.formData.image),o.messageList.push(n),o.$nextTick((function(){o.setPageScrollTo()})));case 1:case"end":return i.stop()}}),i)})))()},hideLoadTips:function(t){var e=this;t?(this.ajax.loadText="消息获取成功",setTimeout((function(){e.ajax.loading=!1}),300)):(this.ajax.loading=!0,this.ajax.loadText="正在获取消息")},onPageScroll:function(t){t.scrollTop<5&&t.scrollTop>=0&&this.getChatList()},inputFocus:function(t){var e=this;this.$util.isAndroid()&&this.inputFirst&&(this.inputShow=!0),this.chatMore=!1,this.$nextTick((function(){e.setPageScrollTo()}))},closePopWindow:function(){this.inputFirst=0,this.chatMore=!1,this.inputShow=!1},openEmjoy:function(){var t=this;console.log(this.emjoyShow,"this.emjoyShow"),this.chatMore=!1,this.emjoyShow=!this.emjoyShow,this.$nextTick((function(){t.setPageScrollTo()}))},addEmjoy:function(e,o){var i=this;t.createSelectorQuery().select("#editor").context((function(t){i.editorCtx=t.context,i.editorCtx.getContents({success:function(t){"<p><br></p>"==t.html&&(t.html="<p></p>");var o=i.$util.img(e),n="<img src="+o+' style="height="20px; width=20px; margin-left=20px;">',r=t.html.replace(/<\/p>$/,n+"</p>");i.editorCtx.setContents({html:r}),i.formData.content=r,i.emjoyShow=!1}})})).exec()},addImg:function(){var t=this;this.$util.upload(1,{path:"chatimg"},(function(e){t.formData.image=e[0],t.sendMsg("image")}),"/servicer/api/chat/chatimg")}},beforeDestroy:function(){clearInterval(this.timeoutObj),this.timeoutObj=null,this.$api.sendRequest({url:"/servicer/api/chat/bye",data:{servicer_id:this.servicer_id,site_id:this.siteId},success:function(e){t.closeSocket()}})}};e.default=u}).call(this,o("543d")["default"])},f95c:function(t,e,o){"use strict";o.d(e,"b",(function(){return i})),o.d(e,"c",(function(){return n})),o.d(e,"a",(function(){}));var i=function(){var t=this,e=t.$createElement,o=(t._self._c,t.emjoyShow?t.__map(t.emjoyList,(function(e,o){var i=t.__get_orig(e),n=t.$util.img(e);return{$orig:i,g0:n}})):null);t.$mp.data=Object.assign({},{$root:{l0:o}})},n=[]}},[["01b2","common/runtime","common/vendor","otherpages/common/vendor"]]]);